<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Товар — TexTrend</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <header>
    <div class="logo"><a href="index.html" style="text-decoration:none;color:inherit">← TexTrend</a></div>
    <a class="wa" id="waTop" target="_blank" rel="noopener">WhatsApp</a>
  </header>

  <div class="wrap">
    <div id="content"></div>
  </div>

  <script>
  const WA = "https://wa.me/905471161988";
  const params = new URLSearchParams(location.search);
  const id = params.get("id");
  const $ = (s)=>document.querySelector(s);

  let PRODUCT=null, VAR=null;

  async function boot(){
    const res = await fetch("products.json?ts="+Date.now());
    const list = await res.json();
    PRODUCT = list.find(p=>p.id===id);
    if(!PRODUCT){ $("#content").innerHTML = "<p>Товар не найден.</p>"; return; }
    VAR = (PRODUCT.variants && PRODUCT.variants[0]) || null;
    render();
  }

  function waLink(){
    const v = VAR ? `Цвет/вариант: ${VAR.color||"—"}\n` : "";
    const img = VAR?.image || (PRODUCT.images && PRODUCT.images[0]) || "";
    const msg = encodeURIComponent(
      `Здравствуйте! Хочу заказать:\n`+
      `• ${PRODUCT.name}\n`+
      (VAR?.sku?`• SKU: ${VAR.sku}\n`:"")+
      (PRODUCT.width_cm?`• Ширина: ${PRODUCT.width_cm} см\n`:"")+
      (PRODUCT.composition?`• Состав: ${PRODUCT.composition}\n`:"")+
      v+
      `• Цена: $${PRODUCT.price_usd} / м\n• Кол-во: ___ м\n`+
      (img?`Фото: ${location.origin}${img}\n`:"")
    );
    return WA+"?text="+msg;
  }

  function render(){
    const img = VAR?.image || (PRODUCT.images && PRODUCT.images[0]) || "/assets/placeholder.jpg";
    const thumbs = (PRODUCT.variants||[])
      .map((v,i)=>`
        <button class="thumb" aria-selected="${VAR&&VAR.image===v.image}" onclick="selectVariant(${i})" title="${v.color||''}">
          <img src="${v.image}" alt="${v.color||('Вариант '+(i+1))}">
        </button>
      `).join("");

    $("#content").innerHTML = `
      <div class="prod">
        <div class="prod__img">
          <img id="mainImg" src="${img}" alt="${PRODUCT.name}">
          ${(PRODUCT.variants&&PRODUCT.variants.length)?`<div class="thumbs">${thumbs}</div>`:""}
        </div>

        <div>
          <h1 style="margin:6px 0">${PRODUCT.name}</h1>
          <div class="muted" style="margin-bottom:6px">
            ${(PRODUCT.category||"")}${PRODUCT.kind? " • "+PRODUCT.kind:""}${PRODUCT.print? " • "+PRODUCT.print:""}${PRODUCT.composition? " • "+PRODUCT.composition:""}${PRODUCT.width_cm? " • "+PRODUCT.width_cm+" см":""}
          </div>
          <div class="price" style="font-size:22px;margin:8px 0">$${PRODUCT.price_usd} / м</div>

          <div class="actions" style="margin-top:14px">
            <a class="btn" href="${img}" target="_blank" rel="noopener">Открыть фото</a>
            <a class="btn primary" id="waBtn" target="_blank" rel="noopener">Заказать в WhatsApp</a>
          </div>
        </div>
      </div>
    `;
    $("#waBtn").href  = waLink();
    $("#waTop").href  = waLink();
  }

  window.selectVariant = function(i){
    const arr = PRODUCT.variants||[];
    VAR = arr[i] || null;
    render();
    document.getElementById("mainImg")?.scrollIntoView({block:"center",behavior:"smooth"});
  };

  boot();
  </script>
</body>
</html>
